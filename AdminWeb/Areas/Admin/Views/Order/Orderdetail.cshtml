@using AdminWeb.Areas.Admin.Models
@using AdminWeb.Areas.Admin.Models.DTOs
@model PagedResponse<OrderDetailDto>

@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var order = Model?.Data?.FirstOrDefault();
}

<h1>@ViewData["Title"]</h1>

<!-- Thông tin đơn hàng -->
@if (order != null)
{
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa fa-globe"></i> Thông tin đơn hàng
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Mã đơn hàng:</dt>
                <dd class="col-sm-9">#@order.OrderId</dd>

                <dt class="col-sm-3">Người nhận:</dt>
                <dd class="col-sm-9">@order.CustomerName</dd>

                <dt class="col-sm-3">Email:</dt>
                <dd class="col-sm-9">@order.Email</dd>

                <dt class="col-sm-3">Số điện thoại:</dt>
                <dd class="col-sm-9">@order.PhoneNumber</dd>

                <dt class="col-sm-3">Địa chỉ giao hàng:</dt>
                <dd class="col-sm-9">
                    @order.Address
                    @if (!string.IsNullOrEmpty(order.City))
                    {
                        <span>, @order.City</span>
                    }
                    @if (!string.IsNullOrEmpty(order.PostalCode))
                    {
                        <span> (@order.PostalCode)</span>
                    }
                </dd>

                <dt class="col-sm-3">Phí vận chuyển:</dt>
                <dd class="col-sm-9">@((order.ShippingFee ?? 0).ToString("N0")) đ</dd>


                <dt class="col-sm-3">Ngày đặt hàng:</dt>
                <dd class="col-sm-9">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</dd>

                <dt class="col-sm-3">Trạng thái:</dt>
                <dd class="col-sm-9">@order.Status</dd>
                <dt class="col-sm-3">Thanh toán:</dt>
                <dd class="col-sm-9">
                    @if (order.PaymentStatus == PaymentStatus.Paid)
                    {
                        <span class="badge bg-success">Đã thanh toán</span>
                    }
                    else if (order.PaymentStatus == PaymentStatus.Pending)
                    {
                        <span class="badge bg-warning text-dark">Chưa thanh toán</span>
                    }
                    else if (order.PaymentStatus == PaymentStatus.Failed)
                    {
                        <span class="badge bg-danger">Thanh toán thất bại</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Không có thông tin</span>
                    }
                </dd>

            </dl>
        </div>
    </div>
}

<!-- Chi tiết sản phẩm -->
<div class="card">
    <div class="card-header">
        <i class="fa fa-star"></i> Chi tiết sản phẩm
    </div>
    <div class="card-body">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Ảnh</th>
                    <th>Tên sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @if (Model?.Data != null && Model.Data.Any())
                {
                    foreach (var item in Model.Data)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <img src="@(item.ImageUrl.StartsWith("http") ? item.ImageUrl : $"http://localhost:7245{item.ImageUrl}")"
                                         alt="@item.ProductName"
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;"
                                         class="img-thumbnail"
                                         title="Path: @item.ImageUrl"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <div style="width: 60px; height: 60px; display: none;"
                                         class="bg-light d-flex align-items-center justify-content-center border rounded">
                                        <i class="fa fa-image text-muted"></i>
                                    </div>
                                }
                                else
                                {
                                    <div style="width: 60px; height: 60px;"
                                         class="bg-light d-flex align-items-center justify-content-center border rounded">
                                        <i class="fa fa-image text-muted"></i>
                                    </div>
                                }
                            </td>
                            <td>@item.ProductName</td>
                            <td>@item.Quantity</td>
                            <td>@item.UnitPrice.ToString("N0") đ</td>
                            <td>@item.SubTotal.ToString("N0") đ</td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center">Không có chi tiết đơn hàng nào</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">Tổng cộng:</th>
                    <th>
                        @Model?.Data?.Sum(x => x.SubTotal).ToString("N0") đ
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Phân trang -->
@if (Model != null && Model.TotalPage > 1)
{
    <nav class="mt-3">
        <ul class="pagination">
            <li class="page-item @(Model.PageNow == 1 ? "disabled" : "")">
                <a class="page-link" asp-action="OrderDetail" asp-route-orderId="@order?.OrderId"
                   asp-route-pageNow="@(Model.PageNow - 1)" asp-route-pageSize="@Model.PageSize">«</a>
            </li>

            @for (int i = 1; i <= Model.TotalPage; i++)
            {
                <li class="page-item @(Model.PageNow == i ? "active" : "")">
                    <a class="page-link" asp-action="OrderDetail" asp-route-orderId="@order?.OrderId"
                       asp-route-pageNow="@i" asp-route-pageSize="@Model.PageSize">@i</a>
                </li>
            }

            <li class="page-item @(Model.PageNow == Model.TotalPage ? "disabled" : "")">
                <a class="page-link" asp-action="OrderDetail" asp-route-orderId="@order?.OrderId"
                   asp-route-pageNow="@(Model.PageNow + 1)" asp-route-pageSize="@Model.PageSize">»</a>
            </li>
        </ul>
    </nav>
}

<div class="mt-3">
    <a asp-area="Admin" asp-controller="Order" asp-action="Index" class="btn btn-secondary">← Quay lại đơn hàng</a>
</div>
